<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>{{ profile.name }} - Fitnessprofil</title>

<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

<style>
.exercise { display: none; }
.exercise.active { display: block; }
.profile-header { display: flex; justify-content: space-between; align-items: center; }

.input-group {
    display: flex;
    flex-direction: column;
    margin: 8px 0;
}

input, select, button {
    padding: 8px;
    margin: 5px 0;
    border-radius: 5px;
    border: none;
    font-size: 14px;
}
</style>
</head>

<body>
<div class="container">

<div class="profile-header">
    <h1>{{ profile.name }} - Fitnessprofil</h1>
    <form method="POST" style="margin:0;" onsubmit="return confirm('Wirklich Fitnessprofil löschen?');">
        <button type="submit" name="delete" class="delete-btn">Fitnessprofil löschen</button>
    </form>
</div>

<!-- ================= Gewicht ================= -->
<h2>Fitnessfortschritt</h2>
<form method="POST" onsubmit="return confirm('Wirklich eintragen?');">

    <div class="input-group">
        <label>Aktuelles Gewicht (kg):</label>
        <input type="number" step="0.1" name="weight" required value="{{ profile.weight }}">
    </div>

    {% if profile.training_focus in ["Joggen", "Radfahren"] %}
        <div class="input-group">
            <label>Strecke (km):</label>
            <input type="number" step="0.01" name="distance" required>
        </div>

        <div class="input-group">
            <label>Zeit (Minuten):</label>
            <input type="number" step="0.1" name="time" required>
        </div>
    {% else %}
        <div class="input-group">
            <label>Trainingszeit (Minuten):</label>
            <input type="number" step="0.1" name="focus_time" required value="30">
        </div>
    {% endif %}

    <div class="input-group">
        <label>Datum:</label>
        <input type="date" name="date" required value="{{ datetime.utcnow().strftime('%Y-%m-%d') }}">
    </div>

    <button type="submit" name="save_weight">in APP Eintragen</button>
</form>

<p>
    <strong>Aktueller BMI:</strong> {{ current_bmi }}
    – <span class="bmi-category">{{ current_category }}</span>
</p>

<!-- ================= Diagramm ================= -->
{% if history %}
<h2>Gewichts-, BMI- & Kalorien-Verlauf</h2>

<canvas id="weightChart" width="600" height="300"></canvas>

<div style="text-align:center; margin-top:10px;">
    <button onclick="resetZoom()">Zoom zurücksetzen</button>
</div>

<script>
const ctx = document.getElementById('weightChart').getContext('2d');

const labels = {{ history|map(attribute='date')|list|tojson }};
const weights = {{ history|map(attribute='weight')|list|tojson }};
const bmiList = {{ bmi_list|tojson }};
const focusList = {{ history|map(attribute='focus')|list|tojson }};
const caloriesList = {{ history|map(attribute='calories')|list|tojson }};

const focusColors = {
    "Ganzkörper": "green",
    "Arme": "blue",
    "Oberkörper": "orange",
    "Bauch/Rücken": "purple",
    "Beine/Po": "red",
    "Joggen": "cyan",
    "Radfahren": "teal",
    "Trampolin": "pink",
    "Yoga": "olive",
    "": "gray"
};

const pointColors = focusList.map(f => focusColors[f] || "gray");

const chart = new Chart(ctx, {
    type: 'line',
    data: {
        labels,
        datasets: [
            {
                label: 'Gewicht (kg)',
                data: weights,
                borderColor: 'blue',
                tension: 0.1,
                fill: false,
                pointBackgroundColor: pointColors,
                pointRadius: 6
            },
            {
                label: 'BMI',
                data: bmiList,
                borderColor: 'red',
                tension: 0.1,
                fill: false
            },
            {
                label: 'Kalorien',
                data: caloriesList,
                borderColor: 'orange',
                tension: 0.1,
                fill: false,
                pointBackgroundColor: pointColors,
                pointRadius: 6
            }
        ]
    },
    options: {
        interaction: { mode: 'index', intersect: false },
        plugins: {
            tooltip: {
                callbacks: {
                    afterBody: function(context) {
                        const idx = context[0].dataIndex;
                        return [
                            'Fokus: ' + (focusList[idx] || '—'),
                            'Kalorien: ' + (caloriesList[idx] || 0) + ' kcal'
                        ];
                    }
                }
            },
            zoom: {
                pan: { enabled: true, mode: 'x' },
                zoom: {
                    wheel: { enabled: true },
                    pinch: { enabled: true },
                    mode: 'x'
                }
            },
            datalabels: {
                display: true,
                align: 'top',
                formatter: (v, c) => focusList[c.dataIndex],
                font: { size: 10 }
            }
        }
    }
});

function resetZoom() {
    chart.resetZoom();
}
</script>
{% endif %}

<!-- ================= Profildaten ================= -->
<h2>Profildaten</h2>
<table>
<tr><th>Alter</th><td>{{ profile.age }}</td></tr>
<tr><th>Geschlecht</th><td>{{ profile.gender }}</td></tr>
<tr><th>Größe</th><td>{{ profile.height }} cm</td></tr>
<tr><th>Startgewicht</th><td>{{ profile.start_weight }} kg</td></tr>
<tr><th>Zielgewicht</th><td>{{ profile.goal_weight }} kg</td></tr>
<tr><th>Trainingstage</th><td>{{ profile.training_days }}</td></tr>
<tr>
    <th>Trainingsfokus</th>
    <td>
        <form method="POST">
            <select name="training_focus">
                {% for focus in EXERCISES.keys() %}
                <option value="{{ focus }}" {% if focus == profile.training_focus %}selected{% endif %}>
                    {{ focus }}
                </option>
                {% endfor %}
            </select>
            <button type="submit" name="update_focus">Ändern</button>
        </form>
    </td>
</tr>
</table>

<!-- ================= ÜBUNGEN ================= -->
<h2>{{ profile.training_focus }}</h2>

{% for ex in exercises %}
<div class="exercise {% if loop.first %}active{% endif %}">
    <h3>{{ ex.name }}</h3>
    <p>{{ ex.description|replace('\n','<br>')|safe }}</p>

    {% if profile.training_focus in ["Joggen", "Radfahren"] %}
        <img src="{{ url_for('static', filename='Bilder/' ~ profile.training_focus ~ '.png') }}"
             alt="{{ profile.training_focus }}">
    {% else %}
        <img src="{{ url_for('static', filename='Bilder/' ~ ex.name ~ '.png') }}"
             alt="{{ ex.name }}"
             onerror="this.style.display='none'">
    {% endif %}
</div>
{% endfor %}

<div style="text-align:center; margin-bottom:20px;">
    <button id="nextExercise">Weiter</button>
</div>

<p style="text-align:center; margin-top:10px;">
    <a href="{{ url_for('index') }}" class="home-btn">Zur Hauptseite</a>
</p>

<script>
let currentIndex = 0;
const exercises = document.querySelectorAll('.exercise');

function showExercise(index) {
    exercises.forEach((ex, i) =>
        ex.classList.toggle('active', i === index)
    );
}

if (exercises.length > 0) {
    document.getElementById('nextExercise').addEventListener('click', () => {
        currentIndex = (currentIndex + 1) % exercises.length;
        showExercise(currentIndex);
    });
}
</script>

</div>
</body>
</html>
